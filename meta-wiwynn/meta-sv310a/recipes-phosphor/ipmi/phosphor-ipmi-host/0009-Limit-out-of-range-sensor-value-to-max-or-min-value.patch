From ed6b1ec749c05e4fd7016deeb9a8824eb160bcdc Mon Sep 17 00:00:00 2001
From: Ren_Chen <Ren_Chen@wiwynn.com>
Date: Fri, 18 Jun 2021 08:54:33 +0800
Subject: [PATCH 06/10] Limit out of range sensor value to max or min value

---
 sensordatahandler.hpp | 15 +++++++++++++--
 1 file changed, 13 insertions(+), 2 deletions(-)

diff --git a/sensordatahandler.hpp b/sensordatahandler.hpp
index 75d8803..3557b7b 100644
--- a/sensordatahandler.hpp
+++ b/sensordatahandler.hpp
@@ -286,8 +286,19 @@ GetSensorResponse readingData(const Info& sensorInfo)
     double value =
         reading * std::pow(10, sensorInfo.scale - sensorInfo.exponentR);
 
-    auto rawData = static_cast<uint8_t>((value - sensorInfo.scaledOffset) /
-                                        sensorInfo.coefficientM);
+    value = (value - sensorInfo.scaledOffset) /
+             sensorInfo.coefficientM;
+
+    if (value > std::numeric_limits<uint8_t>::max())
+    {
+        value = std::numeric_limits<uint8_t>::max();
+    }
+
+    if (value < std::numeric_limits<uint8_t>::min())
+    {
+        value = std::numeric_limits<uint8_t>::min();
+    }
+    uint8_t rawData = static_cast<uint8_t>(round(value));
 
     if (!std::isfinite(value))
     {
-- 
2.32.0

