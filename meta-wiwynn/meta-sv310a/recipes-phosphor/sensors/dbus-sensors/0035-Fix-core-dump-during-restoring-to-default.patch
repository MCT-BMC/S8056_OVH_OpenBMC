From d02963e010c33ca19a8f20ac2eb738cc39373582 Mon Sep 17 00:00:00 2001
From: Wayne Tung <Wayne_Tung@wiwynn.com>
Date: Thu, 6 Jan 2022 14:28:27 +0800
Subject: [PATCH] Fix core dump during restoring to default

---
 src/HwmonTempSensor.cpp | 10 ++++++++--
 src/PSUSensor.cpp       | 10 ++++++++--
 src/TachSensor.cpp      | 12 +++++++++---
 3 files changed, 25 insertions(+), 7 deletions(-)

diff --git a/src/HwmonTempSensor.cpp b/src/HwmonTempSensor.cpp
index a939812..2791d1a 100644
--- a/src/HwmonTempSensor.cpp
+++ b/src/HwmonTempSensor.cpp
@@ -272,9 +272,16 @@ void HwmonTempSensor::readFromTheOtherNode(void)
     uint8_t command = 0x2D;
     std::vector<uint8_t> commandData = {sensorNumber};
 
+    std::weak_ptr<HwmonTempSensor> weakRef = weak_from_this();
     dbusConnection->async_method_call(
-        [this, findSensor](boost::system::error_code ec,
+        [this, findSensor, weakRef](boost::system::error_code ec,
                            const IpmbMethodType& response) {
+            std::shared_ptr<HwmonTempSensor> self = weakRef.lock();
+            if (!self)
+            {
+                return;
+            }
+
             const auto& [status, netFn, rqLun, cmd, cc, data] = response;
             if (ec)
             {
@@ -328,7 +335,6 @@ void HwmonTempSensor::readFromTheOtherNode(void)
                 }
             }
 
-            std::weak_ptr<HwmonTempSensor> weakRef = weak_from_this();
             waitTimer.expires_from_now(std::chrono::milliseconds(sensorPollMs));
             waitTimer.async_wait(
                 [weakRef](const boost::system::error_code& ec) {
diff --git a/src/PSUSensor.cpp b/src/PSUSensor.cpp
index 5e61c3f..f5d4197 100644
--- a/src/PSUSensor.cpp
+++ b/src/PSUSensor.cpp
@@ -341,9 +341,16 @@ void PSUSensor::readFromTheOtherNode(void)
     uint8_t command = 0x2D;
     std::vector<uint8_t> commandData = {sensorNumber};
 
+    std::weak_ptr<PSUSensor> weakRef = weak_from_this();
     dbusConnection->async_method_call(
-        [this, findSensor](boost::system::error_code ec,
+        [this, findSensor, weakRef](boost::system::error_code ec,
                            const IpmbMethodType& response) {
+            std::shared_ptr<PSUSensor> self = weakRef.lock();
+            if (!self)
+            {
+                return;
+            }
+
             const auto& [status, netFn, rqLun, cmd, cc, data] = response;
             if (ec)
             {
@@ -397,7 +404,6 @@ void PSUSensor::readFromTheOtherNode(void)
                 }
             }
 
-            std::weak_ptr<PSUSensor> weakRef = weak_from_this();
             waitTimer.expires_from_now(std::chrono::milliseconds(3000));
             waitTimer.async_wait(
                 [weakRef](const boost::system::error_code& ec) {
diff --git a/src/TachSensor.cpp b/src/TachSensor.cpp
index d07c7ae..513557e 100644
--- a/src/TachSensor.cpp
+++ b/src/TachSensor.cpp
@@ -293,9 +293,16 @@ void TachSensor::readFromTheOtherNode(size_t pollTime)
     uint8_t command = 0x2D;
     std::vector<uint8_t> commandData = {sensorNumber};
 
+    std::weak_ptr<TachSensor> weakRef = weak_from_this();
     dbusConnection->async_method_call(
-        [this, findSensor, pollTime](boost::system::error_code ec,
-                                     const IpmbMethodType& response) {
+        [this, findSensor, pollTime, weakRef](boost::system::error_code ec,
+                                              const IpmbMethodType& response) {
+            std::shared_ptr<TachSensor> self = weakRef.lock();
+            if (!self)
+            {
+                return;
+            }
+
             const auto& [status, netFn, rqLun, cmd, cc, data] = response;
             if (ec)
             {
@@ -339,7 +346,6 @@ void TachSensor::readFromTheOtherNode(size_t pollTime)
                 }
             }
 
-            std::weak_ptr<TachSensor> weakRef = weak_from_this();
             waitTimer.expires_from_now(std::chrono::milliseconds(pollTime));
             waitTimer.async_wait(
                 [weakRef](const boost::system::error_code& ec) {
-- 
2.34.1

