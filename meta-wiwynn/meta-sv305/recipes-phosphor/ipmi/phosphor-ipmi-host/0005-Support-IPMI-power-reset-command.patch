From 29e4266524e00f4498311bedf51ba82db36b6b93 Mon Sep 17 00:00:00 2001
From: Ren_Chen <Ren_Chen@wiwynn.com>
Date: Sun, 25 Oct 2020 12:21:06 +0800
Subject: [PATCH] Support IPMI power reset command

---
 chassishandler.cpp | 34 ++++++++++++++++++++++++++++++++++
 1 file changed, 34 insertions(+)

diff --git a/chassishandler.cpp b/chassishandler.cpp
index 4397f8a..f7b299e 100644
--- a/chassishandler.cpp
+++ b/chassishandler.cpp
@@ -903,6 +903,34 @@ int setNmiProperty(const bool value)
     return 0;
 }
 
+//---------------------------------------------
+// Calls to start systemd unit (service/target)
+//---------------------------------------------
+int startSystemdUnit(const std::string sysUnit)
+{
+    constexpr auto SYSTEMD_SERVICE = "org.freedesktop.systemd1";
+    constexpr auto SYSTEMD_OBJ_PATH = "/org/freedesktop/systemd1";
+    constexpr auto SYSTEMD_INTERFACE = "org.freedesktop.systemd1.Manager";
+
+    sdbusplus::bus::bus bus(ipmid_get_sd_bus_connection());
+
+    try
+    {
+        auto method = bus.new_method_call(SYSTEMD_SERVICE, SYSTEMD_OBJ_PATH,
+                                            SYSTEMD_INTERFACE, "StartUnit");
+        method.append(sysUnit, "replace");
+        bus.call_noreply(method);
+    }
+    catch (std::exception& e)
+    {
+        log<level::ERR>("Failed to start systemd unit",
+                        entry("EXCEPTION=%s", e.what()));
+        return -1;
+    }
+
+    return 0;
+}
+
 namespace power_policy
 {
 
@@ -1421,6 +1449,12 @@ ipmi::RspType<> ipmiChassisControl(uint8_t chassisControl)
             break;
 
         case CMD_HARD_RESET:
+        {
+            // Start the system power reset service
+            std::string resetService("host-powerreset.service");
+            rc = startSystemdUnit(resetService);
+            break;
+        }
         case CMD_POWER_CYCLE:
             // SPEC has a section that says certain implementations can trigger
             // PowerOn if power is Off when a command to power cycle is
-- 
2.28.0

